/*
* RocketPush beta-v0.1 - Copyright © 2015 YHSPY.COM
* Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) license.
*
* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
* AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
* ARE DISCLAIMED. IN NO EVENT SHALL <COPYRIGHT HOLDER> BE LIABLE FOR ANY
* DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
* (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
* LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
* ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
* (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
* THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

!(function(name, context, definition){

	context[name] = definition();

}('RocketPush', this, function () {

	'use strict';
	
	var RocketPush = function (ifload) {

		//If load dependent ?
		if(ifload){
			var scriptJq = document.createElement("script");
			scriptJq.setAttribute("src", "http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js");
			var scriptSi = document.createElement("script");
			scriptSi.setAttribute("src", "http://cdn.bootcss.com/socket.io/1.3.7/socket.io.min.js"); 
			var scriptFp = document.createElement("script");
			scriptFp.setAttribute("src", "http://cdn.bootcss.com/fingerprintjs/v0.5.1/fingerprint.min.js"); 
			
			
			var firstEle = document.getElementsByTagName('head')[0].firstChild;
			var firstHeadEle = document.getElementsByTagName('head')[0];

			firstHeadEle.insertBefore(scriptJq, firstEle);
			firstHeadEle.insertBefore(scriptSi, firstEle);
			firstHeadEle.insertBefore(scriptFp, firstEle);

			//Add hover style
			var style = document.createElement("style");
			style.innerHTML = "#push_wraper:hover{cursor:pointer;opacity:0.9;}";
			firstHeadEle.appendChild(style);
		}

	}

	RocketPush.prototype = {

		errCode: {
			"EXT": "Loading external resources failed! ... Retrying ...",
			"NOR": "Error occur! ... Retrying .." 
		},
		init: function(option){

			/*
			 * RocketPush.init({"connectDelay":2000, "serverAddress":"121.40.119.42", "socketPort":8809});
			 */

			//Read options
			var connectDelay = 1000;
			var serverAddress = "121.40.119.42";
			var socketPort = 2204;
			var thisPointer = this;

			if(typeof(option) == "object"){
				if(typeof(option.connectDelay) != "undefined"){
					connectDelay = option.connectDelay;
				}
				
				if(typeof(option.serverAddress) != "undefined"){
					serverAddress = option.serverAddress;
				}

				if(typeof(option.socketPort) != "undefined"){
					socketPort = option.socketPort;
				}
			}

			//Produce and place 
			var wraper = document.createElement("div");
			wraper.id = "push_wraper";
			wraper.style.position = "fixed";
			wraper.style.width = "100%";
			wraper.style.height = "60px";
			wraper.style.top = "-70px";
			wraper.style.left = "0px";
			wraper.style.color = "white";
			wraper.style.backgroundColor = "black";
			wraper.style.zIndex = "9999";
			wraper.style.borderBottom = "solid 2px white";

			var msgCore = document.createElement("p");
			msgCore.className = "push_msg";
			msgCore.style.fontWeight = "bold";
			msgCore.style.marginLeft = "15px";
			msgCore.style.marginRight = "15px";
			msgCore.style.marginTop = "0px";
			msgCore.style.marginBottom = "0px";
			msgCore.style.padding = "0px";
			msgCore.style.fontSize = "15px";
			msgCore.style.lineHeight = "60px";
			msgCore.style.textAlign = "left";
			msgCore.style.fontFamily = "Microsoft YaHei";

			wraper.appendChild(msgCore);

			//Wait for jQuery loading
			var mainMethod = setInterval(function(){
				try{
					$(document).ready(function(){
						$(document.body).append(wraper);
						//Add event
						$("#push_wraper").on("click", function(){
							$(this).animate({top: "-70px"}, "normal");
						});

						//Get user's finger print
						var uid = new Fingerprint({canvas: true}).get();
						
					    //Connect Server
					    var socket = io("http://" + serverAddress + ":" + socketPort);

					    //Login
					    socket.on('connect', function(){
					    	socket.emit('start_login', uid);
					    });

					    //On new msg
					    socket.on('new_msg_receive', function(msg){
					    	var p = $.parseJSON(msg);
					    	$("#push_wraper").animate({top: "-70px"}, "normal", "linear", function(){					    		
					    		$("#push_wraper .push_msg").html(p.data);					    		
					    	});
					    	$("#push_wraper").animate({top: "0px"}, "normal");
					    });

					    //On other msg
					    socket.on('update_online_user_counts', function(msg){
					    	var p = $.parseJSON(msg);
					        console.log('update_online_user_counts: ' + p.data);
					    });
					});

					window.clearInterval(mainMethod);

				}catch(e){
					if(e.toString().indexOf("ReferenceError: $ is not defined") != -1){
						console.log(thisPointer.errCode.EXT);
					}else{
						console.log(thisPointer.errCode.NOR);
					}
				}

			}, connectDelay);

		}
	}

	return RocketPush;

}));